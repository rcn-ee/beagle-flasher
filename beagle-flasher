#!/bin/bash -e

if ! id | grep -q root; then
	echo "must be run as root"
	exit
fi

version_message="20211118.0: ReWrite from Scratch..."

#mke2fs -c
#Check the device for bad blocks before creating the file system.
#If this option is specified twice, then a slower read-write test is
#used instead of a fast read-only test.

mkfs_options=""
#mkfs_options="-c"
#mkfs_options="-cc"

flush_cache () {
	sync
	if [ "x${destination}" != "x" ] ; then
		message="INFO: flush_cache: [blockdev --flushbufs ${destination}]"                                   ; broadcast
		blockdev --flushbufs ${destination} || true
		message="------------------------------------------------------------------------------------------" ; broadcast
	fi
}

broadcast () {
	if [ "x${message}" != "x" ] ; then
		echo "${message}"
		if [ "x${debug_over_display}" != "x" ] ; then
			echo "${message}" > /dev/${debug_over_display} || true
		fi
	fi
}

broadcast_over_display () {
	if [ "x${message}" != "x" ] ; then
		if [ "x${debug_over_display}" != "x" ] ; then
			echo "${message}" > /dev/${debug_over_display} || true
		fi
	fi
}

example_failure () {
	message="Example: /etc/default/beagle-flasher"                                                       ; broadcast
	message="------------------------------------------------------------------------------------------" ; broadcast
	message="debug_over_display=tty0"                                                                    ; broadcast
	message="source=/dev/mmcblk0"                                                                        ; broadcast
	message="destination=/dev/mmcblk1"                                                                   ; broadcast
	message="rfs_partition=single"                                                                       ; broadcast
	message="rfs_rootfs_type=ext4"                                                                       ; broadcast
	message="rfs_rootfs_startmb=4"                                                                       ; broadcast
	message="------------------------------------------------------------------------------------------" ; broadcast
	exit 2
}

write_failure () {
	message="ERROR: writing to [destination=${destination}] failed..."                                   ; broadcast
	message="------------------------------------------------------------------------------------------" ; broadcast
	flush_cache
	if [ "x${destination}" != "x" ] ; then
		umount ${destination}p1 > /dev/null 2>&1 || true
		umount ${destination}p2 > /dev/null 2>&1 || true
	fi
}

check_running_system () {
	if [ "x${source}" != "x" ] && [ "x${destination}" != "x" ] ; then
		message="INFO: [lsblk -i]"                                                                           ; broadcast
		message="`lsblk -i || true`"                                                                         ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast
		message="INFO: copying [${source}] -> [${destination}]"                                              ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast
	else
		message="INFO: [lsblk -i]"                                                                           ; broadcast
		message="`lsblk -i || true`"                                                                         ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast
		message="ERROR: Setup: [source] and [destination] in /etc/default/beagle-flasher"                    ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast
		example_failure
	fi

	if [ ! -b "${source}" ] ; then
		message="ERROR: [source=${source}] does not exist"                                                   ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast
		example_failure
	else
		message="INFO: [source=${source}] is a valid block device"                                           ; broadcast
	fi

	if [ ! -b "${destination}" ] ; then
		message="ERROR: [destination=${destination}] does not exist"                                         ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast
		example_failure
	else
		message="INFO: [destination=${destination}] is a valid block device"                                 ; broadcast
	fi

	if [ ! -f /sbin/sfdisk ] ; then
		message="ERROR: Missing [/sbin/sfdisk]"                                                              ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast
		example_failure
	fi

	if [ ! -f /sbin/mkfs.ext4 ] ; then
		message="ERROR: Missing [/sbin/mkfs.ext4]"                                                           ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast
		example_failure
	fi

	if [ ! -f /boot/config-$(uname -r) ] ; then
		zcat /proc/config.gz > /boot/config-$(uname -r) || true
		message="INFO: Creating: [/boot/config-$(uname -r)]"                                                 ; broadcast
	else
		message="INFO: [/boot/config-$(uname -r)]"                                                           ; broadcast
	fi

	message="INFO: Generating: [/boot/initrd.img-$(uname -r)]"                                          ; broadcast
	message="update-initramfs: Generating /boot/initrd.img-$(uname -r)"                                 ; broadcast_over_display
	if [ -f /boot/initrd.img-$(uname -r) ] ; then
		update-initramfs -u -k $(uname -r) || true
		message="------------------------------------------------------------------------------------------" ; broadcast
	else
		update-initramfs -c -k $(uname -r) || true
		message="------------------------------------------------------------------------------------------" ; broadcast
	fi
	flush_cache
}

format_single_root () {
	message="/sbin/mkfs.ext4 ${mkfs_options} ${destination}p1 -L ${single_root_label}"                   ; broadcast
	LC_ALL=C /sbin/mkfs.ext4 ${mkfs_options} ${destination}p1 -L ${single_root_label}
	message="------------------------------------------------------------------------------------------" ; broadcast
	flush_cache
}

copy_rootfs () {
	message="INFO: Copying: ${source}p${media_rootfs} -> ${destination}p${media_rootfs}"                 ; broadcast
	mkdir -p /tmp/rootfs/ || true

	message="INFO: [mount ${destination}p${media_rootfs} /tmp/rootfs/ -o async,noatime]"                 ; broadcast
	mount ${destination}p${media_rootfs} /tmp/rootfs/ -o async,noatime

	message="INFO: rsync: [/ -> /tmp/rootfs/]"                                                           ; broadcast
	rsync -aAx /* /tmp/rootfs/ --exclude={/dev/*,/proc/*,/sys/*,/tmp/*,/run/*,/mnt/*,/media/*,/lost+found,/lib/modules/*,/uEnv.txt} || write_failure
	message="------------------------------------------------------------------------------------------" ; broadcast
	flush_cache
}

partition_drive () {
	message="INFO: Erasing: [${destination}]"                                                            ; broadcast
	flush_cache
	message="INFO: [dd if=/dev/zero of=${destination} bs=1M count=108]"                                  ; broadcast
	dd if=/dev/zero of=${destination} bs=1M count=108
	message="------------------------------------------------------------------------------------------" ; broadcast
	sync
	message="INFO: [dd if=${destination} of=/dev/null bs=1M count=108]"                                  ; broadcast
	dd if=${destination} of=/dev/null bs=1M count=108
	message="------------------------------------------------------------------------------------------" ; broadcast
	sync
	flush_cache
	message="INFO: Erasing: [${destination}] complete"                                                   ; broadcast
	message="------------------------------------------------------------------------------------------" ; broadcast

	if [ "x${rfs_partition}" = "xsingle" ] ; then
		rfs_rootfs_startmb=${rfs_rootfs_startmb:-"4"}

		if [ "x${rfs_rootfs_type}" = "xext4" ] ; then
			sfdisk_fstype="L"
		fi
		single_root_label=${single_root_label:-"rootfs"}

		sfdisk_options="--force"
		sfdisk_boot_startmb="${rfs_rootfs_startmb}M"

		message="INFO: Partitioning: ${destination}"                                                         ; broadcast
		message="INFO: /sbin/sfdisk: [$(LC_ALL=C /sbin/sfdisk --version)]"                                   ; broadcast
		message="INFO: /sbin/sfdisk: [/sbin/sfdisk ${sfdisk_options} ${destination}]"                        ; broadcast
		message="INFO: /sbin/sfdisk: [${sfdisk_boot_startmb},,${sfdisk_fstype},*]"                           ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast

		LC_ALL=C /sbin/sfdisk ${sfdisk_options} "${destination}" <<-__EOF__
			${sfdisk_boot_startmb},,${sfdisk_fstype},*
		__EOF__

		flush_cache
		message="INFO: Formatting: ${destination}"                                                           ; broadcast
		format_single_root
		message="INFO: Formatting: ${destination} complete"                                                  ; broadcast
		message="------------------------------------------------------------------------------------------" ; broadcast

		media_rootfs="1"
		copy_rootfs
	else
		example_failure
	fi
}

###FIXME
if [ -f /etc/default/beagle-flasher ] ; then
	clear
	. /etc/default/beagle-flasher
	message="------------------------------------------------------------------------------------------" ; broadcast
	message="Version: [${version_message}]" ; broadcast
	message="------------------------------------------------------------------------------------------" ; broadcast
	message="cat /etc/default/beagle-flasher:"                                                           ; broadcast
	message="------------------------------------------------------------------------------------------" ; broadcast
	message="`cat /etc/default/beagle-flasher`"                                                          ; broadcast
	message="------------------------------------------------------------------------------------------" ; broadcast
else
	message="------------------------------------------------------------------------------------------" ; broadcast
	message="Version: [${version_message}]"                                                              ; broadcast
	message="------------------------------------------------------------------------------------------" ; broadcast
	example_failure
fi

check_running_system
partition_drive
