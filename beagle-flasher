#!/bin/bash -e

if ! id | grep -q root; then
	echo "must be run as root"
	exit
fi

version_message="20211118.0: ReWrite from Scratch..."

flush_cache () {
	sync
	if [ "x${destination}" != "x" ] ; then
		message="INFO: [blockdev --flushbufs ${destination}]"                            ; broadcast
		blockdev --flushbufs ${destination} || true
		message="----------------------------------------------------------------------" ; broadcast
	fi
}

broadcast () {
	if [ "x${message}" != "x" ] ; then
		echo "${message}"
		if [ "x${debug_over_display}" != "x" ] ; then
			echo "${message}" > /dev/${debug_over_display} || true
		fi
	fi
}

example_failure () {
	message="Example: /etc/default/beagle-flasher"                                   ; broadcast
	message="----------------------------------------------------------------------" ; broadcast
	message="debug_over_display=tty0"                                                ; broadcast
	message="source=/dev/mmcblk0"                                                    ; broadcast
	message="destination=/dev/mmcblk1"                                               ; broadcast
	message="----------------------------------------------------------------------" ; broadcast
	exit 2
}

write_failure () {
	message="ERROR: writing to [destination=${destination}] failed..."               ; broadcast
	message="----------------------------------------------------------------------" ; broadcast
	flush_cache
	if [ "x${destination}" != "x" ] ; then
		umount ${destination}p1 > /dev/null 2>&1 || true
		umount ${destination}p2 > /dev/null 2>&1 || true
	fi
}

check_running_system () {
	if [ "x${source}" != "x" ] && [ "x${destination}" != "x" ] ; then
		message="INFO: copying [${source}] -> [${destination}]"                          ; broadcast
		message="INFO: [lsblk]"                                                          ; broadcast
		message="`lsblk || true`"                                                        ; broadcast
		message="----------------------------------------------------------------------" ; broadcast
	else
		message="ERROR: Setup: [source] or [destination] in /etc/default/beagle-flasher" ; broadcast
		message="INFO: [lsblk]"                                                          ; broadcast
		message="`lsblk || true`"                                                        ; broadcast
		message="----------------------------------------------------------------------" ; broadcast
		example_failure
	fi

	if [ ! -b "${destination}" ] ; then
		message="ERROR: [destination=${destination}] does not exist"                     ; broadcast
		message="----------------------------------------------------------------------" ; broadcast
		example_failure
	else
		message="INFO: [destination${destination}] is a valid block device"              ; broadcast
		message="----------------------------------------------------------------------" ; broadcast
	fi

	if [ ! -f /boot/config-$(uname -r) ] ; then
		zcat /proc/config.gz > /boot/config-$(uname -r) || true
		message="INFO: Creating: [/boot/config-$(uname -r)]"                             ; broadcast
		message="----------------------------------------------------------------------" ; broadcast
	else
		message="INFO: [/boot/config-$(uname -r)]"                                       ; broadcast
		message="----------------------------------------------------------------------" ; broadcast
	fi

	if [ -f /boot/initrd.img-$(uname -r) ] ; then
		update-initramfs -u -k $(uname -r) || true
		message="INFO: Updating: [/boot/initrd.img-$(uname -r)]"                         ; broadcast
		message="----------------------------------------------------------------------" ; broadcast
	else
		update-initramfs -c -k $(uname -r) || true
		message="INFO: Creating: [/boot/initrd.img-$(uname -r)]"                         ; broadcast
		message="----------------------------------------------------------------------" ; broadcast
	fi
	flush_cache
}

###FIXME
if [ -f /etc/default/beagle-flasher ] ; then
	clear
	. /etc/default/beagle-flasher
	message="----------------------------------------------------------------------" ; broadcast
	message="Version: [${version_message}]" ; broadcast
	message="----------------------------------------------------------------------" ; broadcast
	message="cat /etc/default/beagle-flasher:"                                       ; broadcast
	message="----------------------------------------------------------------------" ; broadcast
	message="`cat /etc/default/beagle-flasher`"                                      ; broadcast
	message="----------------------------------------------------------------------" ; broadcast
else
	message="----------------------------------------------------------------------" ; broadcast
	message="Version: [${version_message}]"                                          ; broadcast
	message="----------------------------------------------------------------------" ; broadcast
	example_failure
fi

check_running_system
